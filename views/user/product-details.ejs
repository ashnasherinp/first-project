<%- include("../../views/partials/user/header") %>
<main class="main">
 <div class="page-header breadcrumb-wrap">
     <div class="container">
         <div class="breadcrumb">
             <a href="#" rel="nofollow">Home</a>
             <span></span> Shop
             <span></span>product detail page
         </div>
     </div>
 </div>
 <section class="mt-50 mb-50">
     <div class="container">
         <div class="row">
             <div class="col-lg-9">
                 <div class="product-detail accordion-detail">
                     <div class="row mb-50">
                         <div class="col-md-6 col-sm-12 col-xs-12">
                             <div class="detail-gallery">
                                 <span class="zoom-icon"><i class="fi-rs-search"></i></span>
                                 <div class="product-image-slider">
                                     <figure class="border-radius-10">
                                         <img src="/uploads/re-image/<%=product.productImage[0]%>" alt="product image">
                                     </figure>
                                     <figure class="border-radius-10">
                                       <img src="/uploads/re-image/<%=product.productImage[1]%>" alt="product image">
                                   </figure>
                                   <figure class="border-radius-10">
                                       <img src="/uploads/re-image/<%=product.productImage[2]%>" alt="product image">
                                   </figure>
                                   <figure class="border-radius-10">
                                       <img src="/uploads/re-image/<%=product.productImage[3]%>" alt="product image">
                                   </figure>
                                   <figure class="border-radius-10">
                                       <img src="/uploads/re-image/<%=product.productImage[4]%>" alt="product image">
                                   </figure>
                                 </div>
                                 <div  class="slider-nav-thumbnails pl-15 pr-15">
                                    <%for(let i=0;i<product.productImage.length;i++){%>
                                       <div>
                                           <img style="object-fit:contain ;" src="/uploads/re-image/<%=product.productImage[i]%>" alt="product image">
                                       </div>
                                  <%}%>
                                 </div>
                             </div>
                         </div>
                         <div class="col-md-6 col-sm-12 col-xs-12">
                             <div class="detail-info">
                                 <h2 class="title-detail"><%=product.productName%></h2>
                                 <div class="product-detail-rating">
                                     <div class="pro-details-brand">
                                         <span> Brands: <a href="#"><%=product.brand%></a></span>
                                     </div>
                                     <div class="product-rate-cover text-end">
                                         <div class="product-rate d-inline-block">
                                             <div class="product-rating" style="width:90%">
                                             </div>
                                         </div>
                                         <span class="font-small ml-5 text-muted"> (25 reviews)</span>
                                     </div>
                                 </div>
                                 <div class="clearfix product-price-cover">
                                     <div class="product-price primary-color float-left">
                                         <ins><span class="text-brand"><%=product.salePrice%></span></ins>
                                         <ins><span class="old-price font-md ml-15"><%=product.regularPrice%></span></ins>
                                         <span class="save-price  font-md color3 ml-15">
                                            <!-- <%if(!totalOffer){%>
                                                No Offers

                                            <%}else{%>
                                                
                                                <%=totalOffer%> % offer
                                                <%}%> -->

                                                <!-- <%= totalOffer === 0 ? 'No Offers' : totalOffer + ' % offer' %>
                                       </span>

                                       <span class="offer-percentage ml-15">
                                        <%= offerPercentage > 0 ? offerPercentage + '% OFF' : '' %>
                                    </span> -->


                                    <% if (offerPercentage > 0) { %>
                                        <span class="save-price font-md color3 ml-15"><%= offerPercentage %> % OFF</span>
                                    <% } else { %>
                                        <span class="save-price font-md color3 ml-15">No Offers</span>
                                    <% } %>

                                     </div>
                                 </div>
                                 <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                                 <div class="short-desc mb-30">
                                     <p><%=product.description%></p>
                                 </div>
                                 <div class="product_sort_info font-xs mb-30">
                                     <ul>
                                         <!-- <li class="mb-10"><i class="fi-rs-crown mr-5"></i> 1 Year Brand Warranty</li> -->
                                         <li class="mb-10"><i class="fi-rs-refresh mr-5"></i> 5 Day Return Policy(condition applies)</li>
                                         <li><i class="fi-rs-credit-card mr-5"></i> Cash on Delivery available</li>
                                     </ul>
                                 </div>
                                 <div style="display: flex; gap: 1rem; align-items: center;" class="d-flex   font-xs mb-30">
                                  <% variants.forEach((e,i)=>{ %>
                                    <a href="/productDetails?id=<%=variants[i]._id%>">
                                   <div style="display: flex ; flex-direction: column; gap: 1rem; align-items: center;" class="">
                                    <div style="width: 5rem;height: 6rem;border-radius: 15px;position: relative; background-color: aliceblue; display: flex ; align-items: center; flex-direction: column; overflow: hidden;" class="">
                                        <img style="width: 100%; height: 100%; object-fit: cover;position: relative;" src="/uploads/re-image/<%=e.productImage[0]  %>"/>
                                       
                                    </div>
                                        <p><%=e.productName  %></p>
                                        <!-- <p><%=e.size  %></p> -->
                                   </div>
                                    <% }) %>
                                 </div>
                                 
                               
                                 <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                 <!-- <div class="detail-extralink">
                                     <div class="detail-qty border radius">
                                         <a href="#" class="qty-down" onclick="" ><i class="fi-rs-angle-small-down"></i></a>
                                         <span class="qty-val" id="quantity">1</span>
                                         <a href="#" class="qty-up" onclick=""><i class="fi-rs-angle-small-up"></i></a>
                                     </div> -->

                                     <div class="detail-extralink">
                                        <% if (quantity > 0) { %>
                                          <!-- Display stock quantity -->
                                          <div class="stock-info mb-3">
                                            <span class="text-success">In Stock: <%= quantity %> items</span>
                                          </div>
                                      <br>
                                          <!-- Quantity controls -->
                                          <div class="detail-qty border radius">
                                            <a href="#" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                                            <span class="qty-val" id="quantity" >1</span>
                                            <a href="#" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                                          </div>


                                 
  
                                          <!-- Enabled "Add to Cart" button -->
                                          <div class="product-extra-link2">
                                            <button type="submit" id="addToCartBtn" class="button button-add-to-cart"  onclick="addToCart('<%= product._id %>')">Add to cart</button>
                                            <a aria-label="Add To Wishlist" onclick="addToWishlist('<%=product._id%>')"><i class="fi-rs-heart"></i></a>
                                          </div>
                                        <% } else { %>
                                          <!-- Display out of stock message -->
                                          <div class="stock-info mb-3">
                                            <span class="text-danger">Out of Stock</span>
                                          </div>
                                          <!-- Disabled "Add to Cart" button -->
                                          <div class="product-extra-link2">
                                            <button type="button" class="button button-add-to-cart disabled" disabled>Out of Stock</button>
                                            <a aria-label="Add To Wishlist" class="action-btn hover-up"onclick="addToWishlist('<%=product._id%>')"><i class="fi-rs-heart"></i></a>
                                          </div>
                                        <% } %>
                                      </div>
                                      
                                     <!-- <div class="product-extra-link2">
                                      
                                         <button type="submit" class="button button-add-to-cart" onclick="">Add to cart</button>
                                       
                                         <a aria-label="Add To Wishlist" class="action-btn hover-up" href="#"><i class="fi-rs-heart"></i></a>
                                     </div> -->
                                 </div>
                                 <ul class="product-meta font-xs color-grey mt-50">
                                     <li class="mb-5">Stock Code: <a href="#">FWM15VKT</a></li>
                                     <li class="mb-5">Tags: <a href="#" rel="tag"></a> <a href="#" rel="tag"><%=category.name%></a> <a href="#" rel="tag"></a> </li>
                                     <!-- <li>Availability:<span class="in-stock text-success ml-5"><%=quantity%> Items in stock</span></li> -->
                                
                                   
                                
                                    </ul>
                             </div>
                         </div>
                     </div>
                    



                     <!-- Related Products Section -->
<div class="related-products mt-50">
    <h3>Related Products</h3>
    <br>
    <div class="row">
      <% relatedProducts.forEach(function(product) { %>  <!-- Start loop to display related products -->
        <div class="col-md-3">
          <div class="product-card">
            <a href="/productDetails?id=<%=product._id%>">
              <img src="/uploads/re-image/<%= product.productImage[0] %>" alt="<%= product.productName %>">
              <h5><%= product.productName %></h5>
              <p class="price">
                <ins><%= product.salePrice %></ins>
                <!-- <span class="old-price"><%= product.regularPrice %></span> -->
                <del><%= product.regularPrice %></del>
              </p>
            </a>
          </div>
        </div>
      <% }); %> <!-- End loop to display related products -->
    </div>
  </div>
  


                 </div>
             </div>
         </div>
     </div>
 </section>
</main>
<%- include("../../views/partials/user/footer") %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




  
<script>
 


// Increase quantity
document.querySelector('.qty-up').addEventListener('click', function(e) {
    e.preventDefault();
    const quantityInput = document.getElementById('quantity');
    let currentQuantity = parseInt(quantityInput.textContent, 10); // Get current quantity
    currentQuantity = currentQuantity + 1;  // Increase by 1
    quantityInput.textContent = currentQuantity;
     // Update the span with the new quantity
     console.log(currentQuantity)
});

// Decrease quantity
document.querySelector('.qty-down').addEventListener('click', function(e) {
    e.preventDefault();
    const quantityInput = document.getElementById('quantity');
    let currentQuantity = parseInt(quantityInput.textContent, 10); // Get current quantity
    if (currentQuantity > 1) {  // Ensure quantity doesn't go below 1
        currentQuantity = currentQuantity - 1;  // Decrease by 1
        quantityInput.textContent = currentQuantity;
         // Update the span with the new quantity
         console.log(currentQuantity)
    }
});

// The addToCart function now retrieves the updated quantity
function addToCart(productId) {
    const quantityInput = document.getElementById('quantity');
    const quantity = parseInt(quantityInput.textContent, 10); // Get updated quantity
    console.log('quantity:', quantity);

    // Check if the quantity is valid (greater than 0)
    if (isNaN(quantity) || quantity < 1) {
        Swal.fire({
            icon: 'error',
            title: 'Invalid Quantity',
            text: `Please select a valid quantity. Current quantity: ${quantity}`,
        });
        return;
    }

    $.ajax({
        url: '/addToCart',
        method: 'POST',
        data: {
            productId: productId,
            quantity: quantity,
        },
        success: function(response) {
            Swal.fire({
                icon: 'success',
                title: 'Added to Cart',
                text: `Product successfully added to your cart. Quantity: ${quantity}`,
                showConfirmButton: false,
                timer: 1500,
            });
        },
        error: function(error) { 
            const errorMessage = error.responseJSON?.message || 'Failed to add product to cart.'; 
            if (error.responseJSON?.error === 'maxQuantityExceeded') { 
                Swal.fire({ 
                    icon: 'error', 
                    title: 'Limit Exceeded', 
                    text: errorMessage, 
                });
             } else { 
                Swal.fire({ 
                    icon: 'error', 
                    title: 'Error',
                     text: errorMessage,
                     }); 
            } 
        },
    });
}



function addToWishlist(productId){
    $.ajax({
      url:'/addToWishlist',
      method:'POST',
      data :{productId:productId},
      success:(response)=>{
        if(response.status){
          Swal.fire({
            title:"Added to wishlist ",
            text:'The product has been added to wishlist',
            icon:"success",
            timer:2000
          })
        }else{
          Swal.fire({
            title:"Already in wishlist ",
            text:response.message,
            icon:"info",
            timer:2000
          })
        }
      },
      error:(error)=>{
        Swal.fire({
            title:"Error",
            text:'There was an error adding the product to wishlist',
            icon:"error",
            timer:2000
          })
      }
    })

   }
 




</script>